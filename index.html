<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <title>Scheda Fabula Cloud</title>
    <script src="https://unpkg.com/@owlbear-rodeo/sdk"></script>

    <style>
        :root {
            --bg:#f4f8f6; --main:#2f7f6f; --box:#ffffff;
            --border:#cfd8d3; --text:#1f3d36;
        }

        /* ğŸ¨ TEMI */
        body.theme-verde { --bg:#f4f8f6; --main:#2f7f6f; --text:#1f3d36; }
        body.theme-rosa { --bg:#fff2f7; --main:#c94b7c; --text:#4a1f2f; }
        body.theme-notte {
            --bg:#1e1e2a; --main:#8aa8ff; --box:#2a2a3a;
            --border:#444; --text:#eeeeee;
        }
        body.theme-rosso { --bg:#fff1f1; --main:#9b2c2c; --text:#3a1515; }
        body.theme-pergamena { --bg:#f7f0dc; --main:#8b6f3d; --text:#3a2e1a; }

        body { margin:0; font-family: "Segoe UI", sans-serif; background: var(--bg); color: var(--text); padding: 10px; }
        .sheet { max-width: 500px; margin:auto; background: var(--box); padding: 15px; border-radius: 10px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        #sync-status { text-align: center; font-size: 0.7em; margin-bottom: 10px; color: var(--main); font-weight: bold; }
        h2 { margin:10px 0 5px; color: var(--main); font-size: 1.1em; border-bottom: 1px solid var(--border); }
        .box { border:1px solid var(--border); border-radius: 8px; padding: 8px; margin-bottom: 8px; }
        .grid2 { display:grid; grid-template-columns:1fr 1fr; gap:8px; }
        .grid4 { display:grid; grid-template-columns:repeat(4,1fr); gap:6px; }
        label { font-size:0.75em; font-weight: bold; display: block; margin-bottom: 2px; }
        input, textarea, select { 
            width:100%; box-sizing:border-box; border:1px solid var(--border); 
            border-radius:6px; padding:6px; background: var(--box); color: var(--text); 
        }
        textarea { min-height: 80px; }
    </style>
</head>

<body class="theme-verde">

<div class="sheet">
    <div id="sync-status">â˜ï¸ CONNESSIONE AL CLOUD...</div>

    <div class="box">
        <label>ğŸ¨ Scegli Tema</label>
        <select id="current_theme" class="save" onchange="document.body.className=this.value">
            <option value="theme-verde">ğŸŒ¿ Verde</option>
            <option value="theme-rosa">ğŸŒ¸ Rosa</option>
            <option value="theme-notte">ğŸŒ™ Notte</option>
            <option value="theme-rosso">ğŸ”¥ Cremisi</option>
            <option value="theme-pergamena">ğŸ“œ Pergamena</option>
        </select>
    </div>

    <div class="box grid2">
        <label>Nome ğŸ–‹ï¸<input id="char_name" class="save"></label>
        <label>Genere<input id="gender" class="save"></label>
        <label>IdentitÃ <input id="identity" class="save"></label>
        <label>Origine<input id="origin" class="save"></label>
    </div>

    <div class="box">
        <h2>âœ¨ Caratteristiche</h2>
        <div class="grid4">
            <label>DES<input id="des" type="number" class="save" value="6"></label>
            <label>INT<input id="int" type="number" class="save" value="6"></label>
            <label>VIG<input id="vig" type="number" class="save" value="6"></label>
            <label>VOL<input id="vol" type="number" class="save" value="6"></label>
        </div>
    </div>

    <div class="box grid2">
        <label>Livello â­<input id="liv" type="number" class="save" value="5"></label>
        <label>Iniziativa ğŸ¯<input id="init" readonly></label>
    </div>

    <div class="box">
        <h2>â¤ï¸ Punti</h2>
        <div class="grid4">
            <label>PV<input id="pv" readonly></label>
            <label>PM<input id="pm" readonly></label>
            <label>PI<input id="pi" readonly></label>
            <label>Fabula<input id="fabula" class="save"></label>
        </div>
    </div>

    <div class="box grid2">
        <label>Difesa ğŸ›¡ï¸<input id="dif" readonly></label>
        <label>Difesa Magica ğŸ”®<input id="difm" readonly></label>
    </div>

    <div class="box">
        <h2>ğŸ§° Equipaggiamento</h2>
        <textarea id="equip" class="save"></textarea>
    </div>

    <div class="box">
        <h2>ğŸ““ Appunti</h2>
        <textarea id="notes" class="save"></textarea>
    </div>
</div>

<script>
const OBR = window.OBR;

// 1. Calcoli automatici
function calcola() {
    const des = +document.getElementById("des").value || 0;
    const int = +document.getElementById("int").value || 0;
    const vig = +document.getElementById("vig").value || 0;
    const vol = +document.getElementById("vol").value || 0;
    const liv = +document.getElementById("liv").value || 0;

    document.getElementById("pv").value = vig * 5 + liv;
    document.getElementById("pm").value = vol * 5 + liv;
    document.getElementById("pi").value = 6 + liv;
    document.getElementById("dif").value = des;
    document.getElementById("difm").value = int;
    document.getElementById("init").value = des + int;
}

// 2. Salvataggio Cloud
async function cloudSave() {
    const data = {};
    document.querySelectorAll(".save").forEach(el => {
        data[el.id] = el.value;
    });

    try {
        await OBR.player.setMetadata({ "fabula-cloud-v1": data });
        document.getElementById("sync-status").innerText = "âœ¨ SINCRONIZZATO";
    } catch (e) {
        document.getElementById("sync-status").innerText = "âš ï¸ ERRORE SALVATAGGIO";
    }
}

// 3. Caricamento Cloud
async function loadCloudData() {
    try {
        const metadata = await OBR.player.getMetadata();
        const saved = metadata["fabula-cloud-v1"];
        if (saved) {
            Object.keys(saved).forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    el.value = saved[id];
                    if(id === "current_theme") document.body.className = saved[id];
                }
            });
            document.getElementById("sync-status").innerText = "âœ… DATI RECUPERATI";
        }
        calcola();
    } catch (e) {
        document.getElementById("sync-status").innerText = "â˜ï¸ NUOVA SCHEDA";
    }
}

// Inizializzazione
OBR.onReady(() => {
    loadCloudData();

    document.querySelectorAll(".save").forEach(i => {
        i.addEventListener("input", () => {
            calcola();
            cloudSave();
        });
    });
});
</script>

</body>
</html>
