<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <script src="https://unpkg.com/@owlbear-rodeo/sdk"></script>
    <style>
        body { font-family: sans-serif; background: #cbd9e6; padding: 15px; }
        .container { background: #fffcf5; padding: 20px; border-radius: 15px; border: 4px solid #5a7d51; }
        .status { font-size: 0.7rem; text-align: center; margin-bottom: 10px; color: #5a7d51; font-weight: bold; }
        .field-group { margin-bottom: 15px; }
        label { display: block; font-size: 0.8rem; font-weight: bold; margin-bottom: 5px; color: #5a7d51; }
        input, select, textarea { width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box; }
        textarea { min-height: 150px; }
    </style>
</head>
<body>

<div class="container">
    <div id="status" class="status">CONNESSIONE...</div>

    <div class="field-group">
        <label>NOME EROE</label>
        <input type="text" class="fabula-data" id="char_name">
    </div>

    <div class="field-group">
        <label>PV / PM</label>
        <div style="display:flex; gap:10px;">
            <input type="number" class="fabula-data" id="hp" placeholder="PV">
            <input type="number" class="fabula-data" id="mp" placeholder="PM">
        </div>
    </div>

    <div class="field-group">
        <label>NOTE E ABILITÀ</label>
        <textarea class="fabula-data" id="notes"></textarea>
    </div>
</div>

<script>
    const OBR = window.OBR;

    // Funzione UNICA per salvare tutto
    async function saveEverything() {
        const allFields = document.querySelectorAll('.fabula-data');
        const dataToSave = {};
        
        allFields.forEach(field => {
            dataToSave[field.id] = field.value;
        });

        try {
            await OBR.player.setMetadata({ "fabula-cloud-final": dataToSave });
            document.getElementById('status').innerText = "✨ SALVATO ORE: " + new Date().toLocaleTimeString();
        } catch (e) {
            document.getElementById('status').innerText = "⚠️ ERRORE SALVATAGGIO";
        }
    }

    OBR.onReady(async () => {
        // Carica i dati all'avvio
        const metadata = await OBR.player.getMetadata();
        const saved = metadata["fabula-cloud-final"];
        
        if (saved) {
            Object.keys(saved).forEach(id => {
                const el = document.getElementById(id);
                if (el) el.value = saved[id];
            });
            document.getElementById('status').innerText = "✅ DATI CARICATI";
        } else {
            document.getElementById('status').innerText = "☁️ NUOVA SCHEDA";
        }

        // Applica il salvataggio a TUTTI i campi indistintamente
        document.querySelectorAll('.fabula-data').forEach(field => {
            // 'input' cattura ogni singolo tasto premuto, sia in textarea che in input
            field.addEventListener('input', saveEverything);
        });
    });
</script>
</body>
</html>
