<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <script src="https://unpkg.com/@owlbear-rodeo/sdk"></script>
    <style>
        body {
            font-family: sans-serif;
            background: #b0c4de;
            padding: 15px;
            margin: 0;
        }

        #status-bar {
            background: #bc6c4d;
            color: white;
            padding: 10px;
            text-align: center;
            font-size: 0.8rem;
            border-radius: 5px;
            margin-bottom: 15px;
            font-weight: bold;
        }

        .sheet-box {
            background: rgba(255,255,255,0.6);
            padding: 15px;
            border-radius: 10px;
        }

        h3 {
            margin: 15px 0 5px 0;
            font-size: 0.8rem;
            color: #3e5437;
            border-bottom: 1px solid #3e5437;
        }

        label {
            font-size: 0.65rem;
            font-weight: bold;
            color: #3e5437;
        }

        input, textarea {
            width: 100%;
            padding: 8px;
            margin: 4px 0 10px 0;
            border: 1px solid #4682b4;
            border-radius: 5px;
            box-sizing: border-box;
            font-size: 0.75rem;
        }

        textarea {
            resize: vertical;
            min-height: 60px;
        }

        input:disabled, textarea:disabled {
            background: #ddd;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
        }

        .grid-4 {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 8px;
        }
    </style>
</head>
<body>

<div id="status-bar">CARICAMENTO SDK...</div>

<div class="sheet-box">

    <label>NOME PERSONAGGIO</label>
    <input type="text" id="char_name" class="save-field" disabled>

    <h3>CARATTERISTICHE</h3>
    <div class="grid-4">
        <input type="number" id="forza" class="save-field" placeholder="FOR" disabled>
        <input type="number" id="destrezza" class="save-field" placeholder="DES" disabled>
        <input type="number" id="mente" class="save-field" placeholder="MEN" disabled>
        <input type="number" id="volonta" class="save-field" placeholder="VOL" disabled>
    </div>

    <h3>RISORSE</h3>
    <div class="grid-3">
        <input type="number" id="pv" class="save-field" placeholder="PV" disabled>
        <input type="number" id="mp" class="save-field" placeholder="MP" disabled>
        <input type="number" id="pi" class="save-field" placeholder="PI" disabled>
    </div>

    <h3>CLASSI E LIVELLI</h3>
    <textarea id="classi" class="save-field" placeholder="Es: Guerriero 3, Invocatore 2" disabled></textarea>

    <h3>ABILITÃ€</h3>
    <textarea id="abilita" class="save-field" placeholder="Scrivi qui le abilitÃ , talenti, limiti..." disabled></textarea>

</div>

<script>
const OBR = window.OBR;

let currentTokenId = null;
let myPlayerId = null;
let canEdit = false;

OBR.onReady(async () => {
    myPlayerId = await OBR.player.getId();
    document.getElementById('status-bar').innerText = "SELEZIONA LA TUA PEDINA";

    setInterval(async () => {
        const selection = await OBR.player.getSelection();
        if (!selection || selection.length === 0) return;

        if (selection[0] !== currentTokenId) {
            currentTokenId = selection[0];

            const items = await OBR.scene.items.getItems([currentTokenId]);
            if (!items.length) return;

            const token = items[0];
            canEdit = token.createdUserId === myPlayerId;

            document.getElementById('status-bar').innerText =
                canEdit ? "âœï¸ MODIFICANDO: " + token.name : "ðŸ‘€ VISUALIZZANDO: " + token.name;
            document.getElementById('status-bar').style.background =
                canEdit ? "#3e5437" : "#555";

            document.querySelectorAll('.save-field').forEach(el => {
                el.disabled = !canEdit;
            });

            const d = token.metadata["fabula-data"] || {};

            const fields = [
                "char_name","forza","destrezza","mente","volonta",
                "pv","mp","pi","classi","abilita"
            ];

            fields.forEach(id => {
                document.getElementById(id).value = d[id] || "";
            });
        }
    }, 800);
});

async function saveData() {
    if (!currentTokenId || !canEdit) return;

    const data = {};
    document.querySelectorAll('.save-field').forEach(el => {
        data[el.id] = el.value;
    });

    await OBR.scene.items.updateItems([currentTokenId], items => {
        for (let item of items) {
            item.metadata["fabula-data"] = data;
        }
    });
}

document.querySelectorAll('.save-field').forEach(el => {
    el.addEventListener('input', saveData);
});
</script>

</body>
</html>
